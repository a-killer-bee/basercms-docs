#アップデーター基本仕様

baserCMSのアップデート処理を行うスクリプト  
主な処理は次の二つ  

* データベースのバージョン番号をプログラムのバージョン番号に更新する
* コア、プラグイン独自のアップデートプログラムを実行する
* 開発版、ベータ版ではアップデーターは動作しない

##バージョン番号仕様

* バージョン番号のフォーマット 0.0.0  
 * １桁目：メジャーバージョンアップ用（アーキテクチャの変更、管理画面のリニューアル）  
 * ２桁目：マイナーアップデート用（大きめの新機能追加、テーブル構造変更）
 * ３桁目：パッチアップデート用（バグフィックス、セキュリティフィックス）
* バージョン番号を上げるには、上記どれかの数値を「１」足したものとする

##開発版のバージョン番号

開発版のバージョン番号について、開発状況に応じて２つのサフィックスをつける事ができる。

* -alpha：α版。開発途中のバージョンにつける。（アップデーター動作不可）
* -beta：β版。ある程度機能実装が完了し、バグフィックスを目的としフィードバックを求める前提で公開したもの。（アップデーター動作可能）

##アップデーターの配置場所

パッケージ内の下記に配置する  

`{パッケージ}/Config/update/{バージョン番号}/updater.php`

##アップデートメッセージ

アップデート画面に表示するメッセージを指定する事ができる。  
パッケージ内の下記ファイルを作成し、$updateMessage を定義する。  
`{パッケージ}/Config/update/{バージョン番号}/config.php`


##アップデーターで利用できる関数

基本的に、PluginsController に定義されているメソッドは $this 経由で利用可能。

* スキーマ読み込み  
	データベースの構造変更にCakeSchemaを利用できます。  
	ブラウザより、次のURLにアクセスするとスキーマファイルの書き出しが行えますのでそれを利用します。  
	`http://{baserCMSの設置URL}/admin/tools/write_schema`
	
		$this->loadSchema($version, $plugin = '', $filterTable = '', $filterType = '')  
			- $version		アップデート対象のバージョン番号を指定します。（例）'1.6.7'
			- $plugin		プラグイン内のスキーマを読み込むにはプラグイン名を指定します。（例）'mail
			- $filterTable	指定したテーブルのみを追加・更新する場合は、プレフィックスを除外したテーブル名を指定します。（例）'permissions'
							指定しない場合は全てのスキーマファイルが対象となります。
			- $filterType	指定した更新タイプ（create / alter / drop）のみを対象とする場合は更新タイプを指定します。（例）'create'
							指定しない場合はスキーマファイルが対象となります。

	更新タイプによって、ファイル名を変更し、アップデートフォルダに設置します。  
	* `テーブル追加： create_{テーブル名}.php`
	* `テーブル更新： alter_{テーブル名}.php`
	* `テーブル削除： drop_{テーブル名}.php`  
		※ ファイル名に更新タイプを含めない場合は、createとして処理されます。
		
	```
	（例）
	/lib/Baser/Config/update/3.0.7/alter_users.php
	/lib/Baser/Plugin/Blog/Config/update/3.0.7/drop_mail_fields.php
	```
 
* CSVファイルを読み込む  
	CSVファイルによってデータのインポートが行えます。  
	CSVファイルはShift-JISで作成します。  
	1行目には必ずフィールド名が必要です。  
	PRIMARYKEY のフィールドを自動採番するには、1行目のフィールド名は設定した上で値を空文字にします。

		$this->loadCsv($version, $plugin = '', $filterTable = '')  
			- $version		アップデート対象のバージョン番号を指定します。（例）'1.6.7'
			- $plugin		プラグイン内のCSVを読み込むにはプラグイン名を指定します。（例）'mail'
			- $filterTable	指定したテーブルのみCSVを読み込む場合は、プレフィックスを除外したテーブル名を指定します。（例）'permissions'
							指定しない場合は全てのテーブルが対象になります。
							
	次のファイル名で対象バージョンのアップデートフォルダに設置します。  
	`{テーブル名}.csv`
	
	```
	（例）
	/lib/Baser/Config/update/3.0.7/users.csv
	/lib/Baser/Plugin/Blog/Config/update/3.0.7/mail_fields.csv
	```
* アップデートログ出力  
	アップデート完了時に表示するメッセージを設定します。ログにも記録されます。  
	ログファイルの記録場所：/app/tmp/logs/update.log  
	
		$this->setUpdateLog($message)
			- $message			メッセージを指定します。

## アップデーターの実行
アップデーターを実行するには、アップデーターのURLにアクセスして実行します。

`http://{baserCMSの設置URL}/update`

update 部分の文字列は、`Configure` クラスにて管理されています。キー `BcApp.updateKey` を変更する事で、アップデーターのURLを変更する事ができます。

##開発時のテストについて

次期バージョンのアップデートスクリプトを作成する際のテストを行うには、
アップデートフォルダの名称をバージョン番号ではなく、「test」とすると、
WEBサイトのバージョンが更新されず、何度もテストを行えます。  
※ アップデートによって変更された内容のリセットは手動で行う必要があります。

`/lib/Baser/Config/update/test/update.php`

##スキーマの読み込みテストについて
作成したスキーマファイルが正常に読み込めるかをテストする場合には、
ブラウザより次のURLにアクセスし、スキーマファイルをアップロードしてテストを行なえます。

`http://{baserCMSの設置フォルダ}/admin/tools/load_schema`
 
 
##アップデーターでの注意事項

### モデルの利用
スキーマ変更後、モデルを利用してデータの更新を行う場合は、ClassRegistry を利用せず、
モデルクラスを直接イニシャライズしないと、スキーマのキャッシュが古いままとなる。

### フィールドのリネーム
CakeSchema において、リネーム処理は、add と drop の処理となっていしまい、データが消えてしまうのでフィールドのリネーム処理は注意が必要です。あるバージョンで add で追加し、その後のバージョンで drop で削除しましょう。

